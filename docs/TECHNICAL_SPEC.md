<!-- 
    TEMS Technical Specification
    Generated by AI Scaffold — Review Required by TEMS Leads
    Date: 2025-10-16
-->

# TEMS Technical Specification

Transport Excellence Management System (TEMS) — Developer-oriented technical reference for Frappe/ERPNext v15+ deployments.

## Table of Contents

- Executive summary
- Architecture overview
- Module catalog
- Data model and lineage
- Integration patterns (AI, IoT, Payments, USSD)
- Security and permissions
- CI/CD and deployment checklist
- Code organization and style rules
- Testing strategy
- Operational runbooks
- Acceptance tests

---

## Executive summary

TEMS extends ERPNext v15 with domain modules for fleet, operations, safety, finance, cargo, passenger, tyres, AI and more. The system is vehicle-centric: Assets attach to a Vehicle (many→1), operations and costing pivot around Vehicle, and insights roll up to finance and analytics. All customizations live under `apps/tems` without editing ERPNext core. The platform supports multimodal transport, cross-border trade, AI-driven insights, and integrates with IoT sensors, mobile money, and USSD flows.

---

## Architecture overview

- Vehicle is the operational nucleus.
- Assets (Tyres, trailers, parts) link to Vehicle; costs roll up from Asset→Vehicle→Ledger.
- Operations hub (`tems_operations`) orchestrates trip plans, allocations, movement logs, and state transitions.
- Cargo and Passenger branches extend operations with domain-specific doctypes and validations.
- AI layer (`tems_ai`) provides predictions and insights logged to AI Insight Log and consumed by workspaces/dashboards.

See `docs/ARCHITECTURE.md` and diagrams in `diagrams/*.mmd`. Render with mermaid-cli.

---

## Module catalog

Below are primary modules with purpose, example doctypes, handlers, public API endpoints, scheduled tasks, and sample paths. Prefix imports as `tems.tems_{domain}.*`.

### tems_operations — Core execution hub
- Purpose: Plan, allocate, execute and track operations.
- Key DocTypes: Operation Plan, Movement Log, Trip Allocation, Dispatch Schedule, Control Exception, Operations Event, SOS Event.
- Handlers/Hooks: `handlers.validate_operation_plan`, `handlers.ensure_vehicle_available`, `handlers.update_vehicle_status`, `handlers.publish_operations_event`.
- API endpoints:
  - POST `/api/method/tems.tems_operations.api.endpoints.create_operation_plan`
  - POST `/api/method/tems.tems_operations.api.endpoints.log_movement`
- Scheduled jobs: `tasks.check_vehicle_availability` (hourly), `tasks.generate_daily_operations_report` (daily).
- Paths: `tems/tems_operations/doctype/operation_plan/`, `tems/tems_operations/handlers/`, `tems/tems_operations/api/endpoints.py`.

### tems_fleet — Vehicle and asset lifecycle
- Purpose: Manage assets, fuel, maintenance, utilization, route planning.
- Key DocTypes: Maintenance Work Order, Fuel Log, Asset Utilization Log, Route Planning.
- Hooks: `handlers.rollup_asset_cost_to_vehicle`, `handlers.validate_vehicle_assets`.
- API: POST `/api/method/tems.tems_fleet.api.endpoints.create_work_order`
- Jobs: `tasks.compute_predictive_maintenance` (daily), `tasks.sync_asset_costs` (all events).
- Paths: `tems/tems_fleet/doctype/*`, `tems/tems_fleet/handlers/`.

### tems_safety — Risk and compliance
- Purpose: Journey risk, incidents, spot checks, driver competence validation.
- Key DocTypes: Journey Plan, Incident Report, Risk Assessment, Spot Check.
- Hooks: `api.journey_plan.validate_driver_competence`, `handlers.log_incident_against_vehicle`.
- API: POST `/api/method/tems.tems_safety.api.endpoints.report_incident`
- Jobs: `tasks.aggregate_emissions_daily` (daily), `tasks.aggregate_emissions_monthly` (monthly).

### tems_finance — Costs, revenue, profitability
- Purpose: Ledger entries, allocations, fleet costs, journey costing.
- Key DocTypes: Cost and Revenue Ledger, Fleet Costs, Journey Costing, Lease Loan.
- Hooks: `handlers.recalculate_vehicle_profitability` on CRL updates.
- API: POST `/api/method/tems.tems_finance.api.endpoints.post_ledger`
- Jobs: `tasks.update_vehicle_profitability` (all), `tasks.update_fx_rates` (daily).

### tems_cargo — Freight operations
- Purpose: Consignment flow from manifest to delivery.
- Key DocTypes: Cargo Manifest, Cargo Consignment, Waybill, Delivery Log.
- Hooks: `handlers.consignment.validate_vehicle_type` (Vehicle.vehicle_type must be Cargo).
- API: POST `/api/method/tems.tems_cargo.api.endpoints.create_manifest`

### tems_passenger — Transit operations
- Purpose: Passenger trip scheduling and bookings.
- Key DocTypes: Passenger Trip, Booking, Route Schedule.
- Hooks: `handlers.trip.validate_vehicle_type` (Vehicle.vehicle_type must be Passenger).
- API: POST `/api/method/tems.tems_passenger.api.endpoints.create_trip`

### tems_tyre — Tyre lifecycle and analytics
- Purpose: Full tyre lifecycle with AI health scoring and IoT ingestion.
- Key DocTypes: Tyre, Tyre Installation Log, Tyre Inspection Log, Tyre Sensor Data, Tyre Disposal Log.
- Hooks: `handlers.tyre_lifecycle.on_tyre_install`, `on_tyre_inspection`, `on_tyre_disposal`.
- API endpoints:
  - POST `/api/method/tems.tems_tyre.api.endpoints.register_tyre`
  - POST `/api/method/tems.tems_tyre.api.endpoints.install_tyre`
  - POST `/api/method/tems.tems_tyre.api.endpoints.record_inspection`
  - POST `/api/method/tems.tems_tyre.api.endpoints.ingest_sensor_data` (API key)
  - GET `/api/method/tems.tems_tyre.api.endpoints.get_tyre_health?tyre=TYRE-...`
- Jobs: `tasks.update_tyre_health_scores` (daily), `tasks.predict_replacement_schedule` (daily), `tasks.monitor_tyre_sensors` (hourly), `tasks.cleanup_old_sensor_data` (monthly), `tasks.analyze_fleet_tyre_performance` (weekly), `tasks.sync_tyre_costs_to_finance` (daily).
- Paths: `tems/tems_tyre/handlers/tyre_lifecycle.py`, `tems/tems_tyre/api/endpoints.py`.

### tems_ai — Machine learning and insights
- Purpose: Predictions (maintenance, ETA, risk, profitability) and insight logging.
- DocTypes: AI Configuration, AI Model Registry, AI Insight Log.
- API endpoints:
  - POST `/api/method/tems.tems_ai.api.predict.run`
  - POST `/api/method/tems.tems_ai.api.analyze.run`
- Jobs: `tasks.generate_daily_insights` (cron), `tasks.calculate_driver_risk_scores` (cron), `tasks.generate_fleet_maintenance_predictions` (cron), `tasks.forecast_financial_metrics` (cron), `tasks.evaluate_alerts_hourly` (hourly), `tasks.retrain_models_weekly` (weekly), `tasks.cleanup_old_insights` (weekly).
- Paths: `tems/tems_ai/handlers/*`, `tems/tems_ai/services/*`, `tems/tems_ai/api/*`.

### tems_people — HRMS integration
- Purpose: Driver qualifications, training, competencies.
- DocTypes: Driver Qualification, Training Record, Competency Matrix.
- Hooks: `handlers.check_driver_vehicle_assignment` on Employee updates.

### tems_trade — Cross-border trade
- Purpose: Trade lanes, border crossings, customs documents.
- DocTypes: Trade Lane, Border Crossing, Customs Clearance, FX Risk Log.
- Hooks: `handlers.log_vehicle_crossing` on Border Crossing submit.

### tems_climate — Emissions
- Purpose: Emission logs and climate alerts tied to journeys/vehicles.
- DocTypes: Emissions Log, Climate Alert.
- Hooks: `handlers.rollup_emission_to_vehicle` and `handlers.apply_weather_to_vehicle`.

### tems_governance — Policy and audits
- Purpose: Policy, obligations, spot checks, compliance audits.
- DocTypes: Policy, Compliance Obligation, Compliance Audit, Spot Check.
- Hooks: `handlers.on_spot_check`, `handlers.on_compliance_audit`.

### tems_documents — Documents and checklists
- Purpose: Document checklist tooling for Vehicles/Drivers/Trips.
- DocTypes: Document Checklist, Document Checklist Item.

### tems_supply_chain — Spares and logistics
- Purpose: Spare parts, supplier rating, logistics tasks.
- DocTypes: Spare Part, Spare Request, Logistics Task, Supplier Rating.
- Hooks: `handlers.link_spare_parts_to_asset` on Procurement Order submit.

### tems_insights — Dashboards and analytics
- Purpose: Insight dashboards and number cards for workspaces.
- Integration: Frappe Insights, scripted reports, and KPI cards.

---

## Data model and lineage

### Canonical flow

Purchase → Stock → Asset → Vehicle → Operation → Cost/Revenue → Insights

- Procurement creates Assets (Vehicle, Tyre, Equipment) via Stock Entry.
- Assets attach to Vehicle (many→1) by Link fields and/or installation logs.
- Operation Plans validate vehicle type and availability; generate Movement Logs.
- Costs and revenues are captured in `Cost And Revenue Ledger` with optional asset breakdown.
- Finance aggregates to Vehicle profitability; Insights dashboards consume rollups.

### Sample JSON: Vehicle + Tyre + OperationPlan + CostLedger

```json
{
  "vehicle": {
    "name": "VEH-001",
    "vehicle_type": "Cargo",
    "license_plate": "ABC-123XZ",
    "odometer_reading": 52310
  },
  "tyre": {
    "name": "TYRE-2025-00001",
    "brand": "Michelin",
    "size": "315/80R22.5",
    "vehicle": "VEH-001",
    "health_index": 86
  },
  "operation_plan": {
    "name": "OP-20102025-0001",
    "vehicle": "VEH-001",
    "operation_mode": "Cargo",
    "driver": "EMP-00045",
    "start_time": "2025-10-20T08:00:00"
  },
  "cost_ledger_entry": {
    "date": "2025-10-20",
    "vehicle": "VEH-001",
    "type": "Cost",
    "amount": 250.0,
    "currency": "NGN",
    "asset": "TYRE-2025-00001",
    "reference_doctype": "Tyre Inspection Log"
  }
}
```

---

## Integration patterns

### AI (tems_ai)
- Internal calls: `from tems.tems_ai.services.insights_engine import generate_insight`.
- REST APIs: `/api/method/tems.tems_ai.api.predict.run`, `/api/method/tems.tems_ai.api.analyze.run`.
- Auth: Frappe session or API key/secret; store external provider API keys in Site Config or DocType with Encrypted fields.
- Retries: Exponential backoff with jitter; circuit-breaker on repeated failures; log to `AI Insight Log` with status and error.

### IoT sensors (MQTT/REST)
- Pattern A (REST): devices POST to `/api/method/tems.tems_tyre.api.endpoints.ingest_sensor_data` with `X-API-Key`.
- Pattern B (MQTT): Bridge/broker ingests to a webhook or background worker that writes to `Tyre Sensor Data`.
- Security: Rotate device keys; IP allow-list for ingestion; rate limit per sensor; validate timestamps and signature.
- Reliability: Buffer offline; at-least-once delivery; idempotency via `(sensor_id, timestamp)` unique key; dead-letter queue to Redis list.

### Payments (mobile money)
- Webhook endpoint under `tems_finance.api.payments.*` to receive callbacks.
- Verify signature (HMAC), validate amount/currency, and map to `Cost And Revenue Ledger` revenue entries.
- Retry policy: Accept webhook idempotently, return 200 quickly, process asynchronously; reconcile with provider daily.

### USSD
- USSD gateway posts session events to `/api/method/tems.tems_operations.api.ussd.handle`.
- Keep sessions stateless per request with session_id; store USSD state in Redis keyed by session_id and user msisdn.
- Security: Restrict to provider IPs and token; throttle per msisdn.

---

## Security and permissions

- Roles: TEMS Executive, Operations Manager/Officer, Fleet Manager/Officer, Safety Manager/Officer, Finance Manager/Officer, Maintenance Tech, Driver, Informal Operator, Border Agent, Community Leader, Analyst, HR.
- Least privilege: Drivers can create Movement Logs for assigned Operation Plans but cannot edit Vehicle/Asset masters. Fleet Officers manage assets and work orders; Finance Officers manage ledgers; Safety Officers manage incidents and spot checks.
- Data segregation: Field-level permissions via permlevel; `read_only` for calculated rollups; client scripts enforce role-based UI rules.
- Transport security: HTTPS/TLS; Strict-Transport-Security; CSRF enabled.
- Secrets: Store in `site_config.json` or encrypted DocType fields; never in code.
- PII: Avoid PII in sensor records; anonymize where possible; audit trail via Versioning.

---

## CI/CD and deployment checklist

- App install/migrate/build:
```bash
bench --site <site> install-app tems  # first time only
bench --site <site> migrate
bench build
bench clear-cache
bench restart
```
- Fixtures: Ensure roles/workspaces/custom fields included; export with `bench --site <site> export-fixtures`.
- Fixture load order: Roles → Workspace → Custom Field → Reports → Dashboards.
- Smoke tests:
  - Create Vehicle and Asset, link asset to vehicle
  - Create Operation Plan (vehicle availability and type validation)
  - Post Cost And Revenue Ledger entry and verify profitability rollup
  - Create Tyre + Installation + Inspection and verify health index API
- Scheduler validation: Trigger `bench --site <site> trigger-scheduler-event` and verify logs for TEMS tasks.

---

## Code organization and style rules

- Folder layout: one domain per `tems_{domain}` package with `api/`, `handlers/`, `utils/`, `doctype/`, `tasks.py`.
- Handlers: One file per doctype handler (`{doctype}_handlers.py`), functions < 60 lines; factor shared logic into `utils/`.
- File size: Target < 300 LOC per module file; split when exceeding.
- Naming: snake_case for files/functions; DocTypes use Title Case; endpoints live in `api/endpoints.py`.
- Imports: absolute `from tems.tems_{domain}...` to avoid circulars; never import from ERPNext internals.
- Logging: Use `frappe.logger("tems").info(...)` with structured key/value context.
- DB: Prefer Frappe ORM; add indices for frequently queried fields (vehicle, journey_plan, geohash, status, timestamps).

---

## Testing strategy

- Unit tests: per domain under `tems/tems_{domain}/tests/`; mock external services; validate handlers and utils.
- Integration tests: end-to-end flows: Vehicle→Operation Plan→Movement Log→Ledger; Tyre lifecycle; AI insight generation.
- Smoke tests: lightweight checks post-deploy; verify scheduler and hooks.
- Dataset seeding: `tems/setup_test_data.py` and `tems/create_test_users.py` provide sample data; add `master_seed.py` to create core masters.
- Validation checks: enforce vehicle_type on cargo/passenger modules; expired Driver Qualification should block Journey Plan submit.

---

## Operational runbooks

### Routine maintenance
- Daily: Review scheduler logs, AI insight summary, overdue work orders.
- Weekly: Reindex key tables, review tyre performance report, retrain AI models (automated).
- Monthly: Archive old sensor data; verify backup restore.

### Incident: Scheduler failure
- Symptoms: No daily tasks running; insights not generated.
- Steps:
  1) `bench doctor` to inspect scheduler
  2) `bench restart` and `bench enable-scheduler`
  3) Manually run a task: `bench execute tems.tems_ai.tasks.generate_daily_insights`
  4) Inspect `logs/scheduler.log` and Redis health

### Backup strategy
- Nightly DB and files backup; 30-day retention; offsite object storage.
- Quarterly restore drills; checksum verify.

---

## Acceptance tests

- Vehicle-Asset link: Create Asset and link to Vehicle; verify reverse lookup and cost rollup entry in CRL.
- Operation Plan vehicle type validation: Create plan with mismatched module type and expect validation failure.
- Tyre lifecycle traceability: Register→Install→Inspect→Disposal; verify audit chain and cost sync to finance.
- AI insight logs: Trigger `generate_daily_insights` and verify entries created with confidence scores.

Run automated tests:
```bash
bench --site <site> run-tests --app tems --module tems_operations
bench --site <site> run-tests --app tems --module tems_tyre
bench --site <site> run-tests --app tems --module tems_ai
```

---

Appendix
- Related: `docs/ARCHITECTURE.md`, `diagrams/*.mmd`, `tems/tems/doc/doctype_reference.md`.
- Ownership: TEMS Dev Team — code@tevcng.com.
- Last updated: 2025-10-16.
