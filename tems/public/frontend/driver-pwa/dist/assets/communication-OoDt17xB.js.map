{"version":3,"file":"communication-OoDt17xB.js","sources":["../../../../../../frontend/driver-pwa/src/stores/communication.js"],"sourcesContent":["import { defineStore } from 'pinia'\nimport { ref, computed } from 'vue'\nimport frappeClient from '@/utils/frappeClient'\n\nexport const useCommunicationStore = defineStore('communication', () => {\n    const messages = ref([])\n    const notifications = ref([])\n    const unreadCount = ref(0)\n    const loading = ref(false)\n    const error = ref(null)\n\n    const unreadNotifications = computed(() =>\n        notifications.value.filter(n => !n.read)\n    )\n\n    async function fetchMessages() {\n        loading.value = true\n        error.value = null\n\n        try {\n            const data = await frappeClient.call('tems.api.pwa.driver.get_messages')\n            messages.value = data || []\n            return data\n        } catch (err) {\n            error.value = err.message\n            throw err\n        } finally {\n            loading.value = false\n        }\n    }\n\n    async function sendMessage(recipientType, recipientId, message) {\n        loading.value = true\n\n        try {\n            const result = await frappeClient.call('tems.api.pwa.driver.send_message', {\n                recipient_type: recipientType,\n                recipient_id: recipientId,\n                message: message,\n                timestamp: new Date().toISOString()\n            })\n\n            // Add to local messages\n            messages.value.push({\n                ...result,\n                sender: 'me',\n                message: message,\n                timestamp: new Date().toISOString()\n            })\n\n            return result\n        } catch (err) {\n            error.value = err.message\n            throw err\n        } finally {\n            loading.value = false\n        }\n    }\n\n    async function fetchNotifications() {\n        loading.value = true\n\n        try {\n            const data = await frappeClient.call('tems.api.pwa.driver.get_notifications')\n            notifications.value = data || []\n            unreadCount.value = unreadNotifications.value.length\n            return data\n        } catch (err) {\n            error.value = err.message\n            throw err\n        } finally {\n            loading.value = false\n        }\n    }\n\n    async function markNotificationRead(notificationId) {\n        try {\n            await frappeClient.call('tems.api.pwa.driver.mark_notification_read', {\n                notification_id: notificationId\n            })\n\n            const notification = notifications.value.find(n => n.name === notificationId)\n            if (notification) {\n                notification.read = true\n                unreadCount.value = unreadNotifications.value.length\n            }\n        } catch (err) {\n            error.value = err.message\n            throw err\n        }\n    }\n\n    function addLocalNotification(notification) {\n        notifications.value.unshift({\n            ...notification,\n            read: false,\n            timestamp: new Date().toISOString()\n        })\n        unreadCount.value++\n    }\n\n    return {\n        messages,\n        notifications,\n        unreadCount,\n        unreadNotifications,\n        loading,\n        error,\n        fetchMessages,\n        sendMessage,\n        fetchNotifications,\n        markNotificationRead,\n        addLocalNotification\n    }\n})\n"],"names":["useCommunicationStore","defineStore","messages","ref","notifications","unreadCount","loading","error","unreadNotifications","computed","n","fetchMessages","data","frappeClient","err","sendMessage","recipientType","recipientId","message","result","fetchNotifications","markNotificationRead","notificationId","notification","addLocalNotification"],"mappings":"wDAIY,MAACA,EAAwBC,EAAY,gBAAiB,IAAM,CACpE,MAAMC,EAAWC,EAAI,CAAA,CAAE,EACjBC,EAAgBD,EAAI,CAAA,CAAE,EACtBE,EAAcF,EAAI,CAAC,EACnBG,EAAUH,EAAI,EAAK,EACnBI,EAAQJ,EAAI,IAAI,EAEhBK,EAAsBC,EAAS,IACjCL,EAAc,MAAM,OAAOM,GAAK,CAACA,EAAE,IAAI,CAC/C,EAEI,eAAeC,GAAgB,CAC3BL,EAAQ,MAAQ,GAChBC,EAAM,MAAQ,KAEd,GAAI,CACA,MAAMK,EAAO,MAAMC,EAAa,KAAK,kCAAkC,EACvE,OAAAX,EAAS,MAAQU,GAAQ,CAAA,EAClBA,CACX,OAASE,EAAK,CACV,MAAAP,EAAM,MAAQO,EAAI,QACZA,CACV,QAAC,CACGR,EAAQ,MAAQ,EACpB,CACJ,CAEA,eAAeS,EAAYC,EAAeC,EAAaC,EAAS,CAC5DZ,EAAQ,MAAQ,GAEhB,GAAI,CACA,MAAMa,EAAS,MAAMN,EAAa,KAAK,mCAAoC,CACvE,eAAgBG,EAChB,aAAcC,EACd,QAASC,EACT,UAAW,IAAI,KAAI,EAAG,YAAW,CACjD,CAAa,EAGD,OAAAhB,EAAS,MAAM,KAAK,CAChB,GAAGiB,EACH,OAAQ,KACR,QAASD,EACT,UAAW,IAAI,KAAI,EAAG,YAAW,CACjD,CAAa,EAEMC,CACX,OAASL,EAAK,CACV,MAAAP,EAAM,MAAQO,EAAI,QACZA,CACV,QAAC,CACGR,EAAQ,MAAQ,EACpB,CACJ,CAEA,eAAec,GAAqB,CAChCd,EAAQ,MAAQ,GAEhB,GAAI,CACA,MAAMM,EAAO,MAAMC,EAAa,KAAK,uCAAuC,EAC5E,OAAAT,EAAc,MAAQQ,GAAQ,CAAA,EAC9BP,EAAY,MAAQG,EAAoB,MAAM,OACvCI,CACX,OAASE,EAAK,CACV,MAAAP,EAAM,MAAQO,EAAI,QACZA,CACV,QAAC,CACGR,EAAQ,MAAQ,EACpB,CACJ,CAEA,eAAee,EAAqBC,EAAgB,CAChD,GAAI,CACA,MAAMT,EAAa,KAAK,6CAA8C,CAClE,gBAAiBS,CACjC,CAAa,EAED,MAAMC,EAAenB,EAAc,MAAM,KAAKM,GAAKA,EAAE,OAASY,CAAc,EACxEC,IACAA,EAAa,KAAO,GACpBlB,EAAY,MAAQG,EAAoB,MAAM,OAEtD,OAASM,EAAK,CACV,MAAAP,EAAM,MAAQO,EAAI,QACZA,CACV,CACJ,CAEA,SAASU,EAAqBD,EAAc,CACxCnB,EAAc,MAAM,QAAQ,CACxB,GAAGmB,EACH,KAAM,GACN,UAAW,IAAI,KAAI,EAAG,YAAW,CAC7C,CAAS,EACDlB,EAAY,OAChB,CAEA,MAAO,CACH,SAAAH,EACA,cAAAE,EACA,YAAAC,EACA,oBAAAG,EACA,QAAAF,EACA,MAAAC,EACA,cAAAI,EACA,YAAAI,EACA,mBAAAK,EACA,qBAAAC,EACA,qBAAAG,CACR,CACA,CAAC"}