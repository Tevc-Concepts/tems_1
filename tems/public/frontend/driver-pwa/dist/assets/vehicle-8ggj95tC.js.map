{"version":3,"file":"vehicle-8ggj95tC.js","sources":["../../../../../../frontend/driver-pwa/src/stores/vehicle.js"],"sourcesContent":["import { defineStore } from 'pinia'\nimport { ref, computed } from 'vue'\nimport { frappeClient } from '@shared'\n\nexport const useVehicleStore = defineStore('vehicle', () => {\n  const vehicles = ref([])\n  const currentVehicle = ref(null)\n  const vehicleHistory = ref([])\n  const fuelLogs = ref([])\n  const maintenanceRecords = ref([])\n  const loading = ref(false)\n  const error = ref(null)\n\n  const assignedVehicles = computed(() => \n    vehicles.value.filter(v => v.status === 'Active')\n  )\n\n  const currentVehicleDetails = computed(() => {\n    if (!currentVehicle.value) return null\n    \n    return {\n      ...currentVehicle.value,\n      lastFuel: fuelLogs.value[0] || null,\n      pendingMaintenance: maintenanceRecords.value.filter(\n        m => m.status === 'Open' || m.status === 'In Progress'\n      )\n    }\n  })\n\n  async function fetchVehicleInfo(vehicleName) {\n    loading.value = true\n    error.value = null\n    \n    try {\n      const data = await frappeClient.call('tems.api.pwa.driver.get_vehicle_info', {\n        vehicle_name: vehicleName\n      })\n      \n      currentVehicle.value = data.vehicle\n      fuelLogs.value = data.last_fuel ? [data.last_fuel] : []\n      maintenanceRecords.value = data.pending_maintenance || []\n      \n      return data\n    } catch (err) {\n      error.value = err.message\n      throw err\n    } finally {\n      loading.value = false\n    }\n  }\n\n  async function fetchMyVehicles() {\n    loading.value = true\n    error.value = null\n    \n    try {\n      // Get vehicles assigned to current driver's trips\n      const trips = await frappeClient.call('tems.api.pwa.driver.get_driver_dashboard')\n      \n      const vehicleNames = [\n        ...new Set([\n          ...trips.journey_plans.map(jp => jp.vehicle),\n          ...trips.operation_plans.map(op => op.vehicle)\n        ].filter(Boolean))\n      ]\n      \n      if (vehicleNames.length > 0) {\n        const vehicleData = await Promise.all(\n          vehicleNames.map(name => \n            frappeClient.getDoc('Vehicle', name).catch(() => null)\n          )\n        )\n        \n        vehicles.value = vehicleData.filter(Boolean)\n      }\n      \n      return vehicles.value\n    } catch (err) {\n      error.value = err.message\n      throw err\n    } finally {\n      loading.value = false\n    }\n  }\n\n  async function logFuel(fuelData) {\n    loading.value = true\n    error.value = null\n    \n    try {\n      const result = await frappeClient.call('tems.api.pwa.driver.log_fuel', {\n        vehicle: fuelData.vehicle,\n        liters: fuelData.liters,\n        price_per_liter: fuelData.pricePerLiter,\n        odometer: fuelData.odometer,\n        station: fuelData.station,\n        location_data: fuelData.locationData\n      })\n      \n      // Add to local fuel logs\n      fuelLogs.value.unshift({\n        name: result.fuel_log,\n        vehicle: fuelData.vehicle,\n        liters: fuelData.liters,\n        total_cost: result.total_cost,\n        date: new Date().toISOString(),\n        odometer: fuelData.odometer\n      })\n      \n      return result\n    } catch (err) {\n      error.value = err.message\n      throw err\n    } finally {\n      loading.value = false\n    }\n  }\n\n  async function submitSpotCheck(checkData) {\n    loading.value = true\n    error.value = null\n    \n    try {\n      // Upload photos first if any\n      const uploadedPhotos = []\n      if (checkData.photos && checkData.photos.length > 0) {\n        for (const photo of checkData.photos) {\n          if (photo.file) {\n            const uploadResult = await frappeClient.uploadFile(\n              photo.file,\n              false,\n              'Home/Vehicle Inspections'\n            )\n            uploadedPhotos.push({\n              image: uploadResult.file_url,\n              caption: photo.caption || ''\n            })\n          }\n        }\n      }\n      \n      const result = await frappeClient.call('tems.api.pwa.driver.submit_spot_check', {\n        vehicle: checkData.vehicle,\n        location: checkData.location,\n        notes: checkData.notes,\n        photos: uploadedPhotos\n      })\n      \n      return result\n    } catch (err) {\n      error.value = err.message\n      throw err\n    } finally {\n      loading.value = false\n    }\n  }\n\n  async function fetchFuelHistory(vehicleName, limit = 10) {\n    loading.value = true\n    \n    try {\n      const logs = await frappeClient.getList(\n        'Fuel Log',\n        ['name', 'date', 'liters', 'total_cost', 'odometer', 'station'],\n        { vehicle: vehicleName },\n        limit,\n        'date desc'\n      )\n      \n      fuelLogs.value = logs\n      return logs\n    } catch (err) {\n      error.value = err.message\n      throw err\n    } finally {\n      loading.value = false\n    }\n  }\n\n  async function fetchMaintenanceHistory(vehicleName, limit = 10) {\n    loading.value = true\n    \n    try {\n      const records = await frappeClient.getList(\n        'Maintenance Work Order',\n        ['name', 'status', 'planned_date', 'completion_date', 'cost', 'vendor'],\n        { vehicle: vehicleName },\n        limit,\n        'planned_date desc'\n      )\n      \n      maintenanceRecords.value = records\n      return records\n    } catch (err) {\n      error.value = err.message\n      throw err\n    } finally {\n      loading.value = false\n    }\n  }\n\n  async function getVehicleUtilization(vehicleName, startDate, endDate) {\n    try {\n      const data = await frappeClient.getList(\n        'Asset Utilization Log',\n        ['log_date', 'utilization_hours'],\n        { \n          vehicle: vehicleName,\n          log_date: ['between', [startDate, endDate]]\n        },\n        100,\n        'log_date desc'\n      )\n      \n      return data\n    } catch (err) {\n      error.value = err.message\n      throw err\n    }\n  }\n\n  function setCurrentVehicle(vehicle) {\n    currentVehicle.value = vehicle\n  }\n\n  function clearCurrentVehicle() {\n    currentVehicle.value = null\n    fuelLogs.value = []\n    maintenanceRecords.value = []\n  }\n\n  return {\n    vehicles,\n    currentVehicle,\n    vehicleHistory,\n    fuelLogs,\n    maintenanceRecords,\n    loading,\n    error,\n    assignedVehicles,\n    currentVehicleDetails,\n    fetchVehicleInfo,\n    fetchMyVehicles,\n    logFuel,\n    submitSpotCheck,\n    fetchFuelHistory,\n    fetchMaintenanceHistory,\n    getVehicleUtilization,\n    setCurrentVehicle,\n    clearCurrentVehicle\n  }\n})"],"names":["useVehicleStore","defineStore","vehicles","ref","currentVehicle","vehicleHistory","fuelLogs","maintenanceRecords","loading","error","assignedVehicles","computed","v","currentVehicleDetails","m","fetchVehicleInfo","vehicleName","data","frappeClient","err","fetchMyVehicles","trips","vehicleNames","jp","op","vehicleData","name","logFuel","fuelData","result","submitSpotCheck","checkData","uploadedPhotos","photo","uploadResult","fetchFuelHistory","limit","logs","fetchMaintenanceHistory","records","getVehicleUtilization","startDate","endDate","setCurrentVehicle","vehicle","clearCurrentVehicle"],"mappings":"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"}