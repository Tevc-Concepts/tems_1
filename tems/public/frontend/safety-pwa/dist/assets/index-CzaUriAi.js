const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/Login-471oyKIN.js","assets/vue-vendor-Dxtg618h.js","assets/logo-MG8gPAg-.js","assets/utils-CX__Uu54.js","assets/Layout-B1PQsy11.js","assets/Dashboard-BUjUSF5b.js","assets/Incidents-BOsa0AFR.js","assets/IncidentDetails-CnPGN6J6.js","assets/SafetyAudits-CrOc7A8Y.js","assets/Compliance-taaNpXp4.js","assets/RiskAssessment-0iBqA98S.js","assets/Reports-lEwIutd_.js","assets/Settings-BVeyQxwk.js"])))=>i.map(i=>d[i]);
import{d as b,r as v,c as T,s as A,o as D,a as x,b as F,w as U,T as j,e as M,f as C,g as R,F as N,h as W,u as I,n as z,i as y,j as V,t as B,k as X,l as H,m as J,p as G,q as Q,v as K,x as Y}from"./vue-vendor-Dxtg618h.js";import{r as Z,g as ee}from"./utils-CX__Uu54.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))n(r);new MutationObserver(r=>{for(const s of r)if(s.type==="childList")for(const o of s.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&n(o)}).observe(document,{childList:!0,subtree:!0});function e(r){const s={};return r.integrity&&(s.integrity=r.integrity),r.referrerPolicy&&(s.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?s.credentials="include":r.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function n(r){if(r.ep)return;r.ep=!0;const s=e(r);fetch(r.href,s)}})();const te="modulepreload",ne=function(u){return"/assets/tems/frontend/safety-pwa/dist/"+u},O={},_=function(t,e,n){let r=Promise.resolve();if(e&&e.length>0){let l=function(c){return Promise.all(c.map(i=>Promise.resolve(i).then(h=>({status:"fulfilled",value:h}),h=>({status:"rejected",reason:h}))))};document.getElementsByTagName("link");const o=document.querySelector("meta[property=csp-nonce]"),a=o?.nonce||o?.getAttribute("nonce");r=l(e.map(c=>{if(c=ne(c),c in O)return;O[c]=!0;const i=c.endsWith(".css"),h=i?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${c}"]${h}`))return;const p=document.createElement("link");if(p.rel=i?"stylesheet":te,i||(p.as="script"),p.crossOrigin="",p.href=c,a&&p.setAttribute("nonce",a),document.head.appendChild(p),i)return new Promise((d,g)=>{p.addEventListener("load",d),p.addEventListener("error",()=>g(new Error(`Unable to preload CSS for ${c}`)))})}))}function s(o){const a=new Event("vite:preloadError",{cancelable:!0});if(a.payload=o,window.dispatchEvent(a),!a.defaultPrevented)throw o}return r.then(o=>{for(const a of o||[])a.status==="rejected"&&s(a.reason);return t().catch(s)})};var re=Z();const $=ee(re);class se{constructor(){this.baseURL=window.location.origin,this.isOnline=navigator.onLine,this.retryAttempts=3,this.retryDelay=1e3,this.offlineStore=$.createInstance({name:"tems_offline"}),this.queueStore=$.createInstance({name:"tems_queue"}),window.addEventListener("online",()=>{this.isOnline=!0,this.syncOfflineData()}),window.addEventListener("offline",()=>{this.isOnline=!1})}async call(t,e={},n=!1,r=!0){const s=`${this.baseURL}/api/method/${t}`,o=`rpc:${t}:${JSON.stringify(e)}`;try{const a=await this.fetchWithRetry(s,{method:"POST",headers:{"Content-Type":"application/json","X-Frappe-CSRF-Token":this.getCSRFToken()},credentials:"include",body:JSON.stringify(e)});if(!a.ok){const c=await a.json().catch(()=>({}));if(a.status===400&&(c.exc_type==="CSRFTokenError"||c.message?.includes("Invalid Request")||c.message?.includes("CSRF"))&&r)return console.warn("CSRF token error detected, refreshing token and retrying..."),await this.refreshCSRFToken(),this.call(t,e,n,!1);throw new Error(c.message||`HTTP error! status: ${a.status}`)}const l=await a.json();return n&&l.message&&await this.offlineStore.setItem(o,{data:l.message,timestamp:Date.now()}),l.message}catch(a){if(!this.isOnline)return this.handleOfflineRequest(o);throw a}}async getDoc(t,e){const n=`${this.baseURL}/api/resource/${t}/${e}`,r=`${t}:${e}`;try{const s=await this.fetchWithRetry(n,{credentials:"include",headers:{"X-Frappe-CSRF-Token":this.getCSRFToken()}});if(!s.ok)throw new Error(`HTTP error! status: ${s.status}`);const o=await s.json();return await this.offlineStore.setItem(r,{data:o.data,timestamp:Date.now()}),o.data}catch(s){if(!this.isOnline){const o=await this.offlineStore.getItem(r);if(o)return o.data}throw s}}async getList(t,e=["name"],n={},r=20,s="modified desc"){const o=`${this.baseURL}/api/resource/${t}`,a=new URLSearchParams({fields:JSON.stringify(e),filters:JSON.stringify(n),limit_page_length:r,order_by:s}),l=`list:${t}:${JSON.stringify(n)}:${r}`;try{const c=await this.fetchWithRetry(`${o}?${a}`,{credentials:"include",headers:{"X-Frappe-CSRF-Token":this.getCSRFToken()}});if(!c.ok)throw new Error(`HTTP error! status: ${c.status}`);const i=await c.json();return await this.offlineStore.setItem(l,{data:i.data,timestamp:Date.now()}),i.data}catch(c){if(!this.isOnline){const i=await this.offlineStore.getItem(l);if(i)return i.data}throw c}}async setDoc(t,e,n){if(!this.isOnline)return this.queueOfflineWrite(t,e,n,"update");const r=`${this.baseURL}/api/resource/${t}/${e}`,s=await this.fetchWithRetry(r,{method:"PUT",headers:{"Content-Type":"application/json","X-Frappe-CSRF-Token":this.getCSRFToken()},credentials:"include",body:JSON.stringify(n)});if(!s.ok)throw new Error(`HTTP error! status: ${s.status}`);const o=await s.json();return await this.offlineStore.setItem(`${t}:${e}`,{data:o.data,timestamp:Date.now()}),o.data}async createDoc(t,e){if(!this.isOnline)return this.queueOfflineWrite(t,null,e,"create");const n=`${this.baseURL}/api/resource/${t}`,r=await this.fetchWithRetry(n,{method:"POST",headers:{"Content-Type":"application/json","X-Frappe-CSRF-Token":this.getCSRFToken()},credentials:"include",body:JSON.stringify(e)});if(!r.ok){const s=await r.json().catch(()=>({}));throw new Error(s.message||"Failed to create document")}return await r.json()}async deleteDoc(t,e){if(!this.isOnline)return this.queueOfflineWrite(t,e,{},"delete");const n=`${this.baseURL}/api/resource/${t}/${e}`;if(!(await fetch(n,{method:"DELETE",headers:{"X-Frappe-CSRF-Token":this.getCSRFToken()},credentials:"include"})).ok)throw new Error("Failed to delete document");await this.offlineStore.removeItem(`${t}:${e}`)}async uploadFile(t,e=!1,n="Home",r=null,s=null){const o=new FormData;o.append("file",t),o.append("is_private",e?1:0),o.append("folder",n),r&&o.append("doctype",r),s&&o.append("docname",s);const a=await fetch(`${this.baseURL}/api/method/upload_file`,{method:"POST",headers:{"X-Frappe-CSRF-Token":this.getCSRFToken()},credentials:"include",body:o});if(!a.ok)throw new Error("Upload failed");return(await a.json()).message}async fetchWithRetry(t,e,n=1){try{return await fetch(t,e)}catch(r){if(n<this.retryAttempts&&this.isOnline)return await this.delay(this.retryDelay*n),this.fetchWithRetry(t,e,n+1);throw r}}getCSRFToken(){const t=document.querySelector('meta[name="csrf-token"]')?.getAttribute("content");if(t)return t;const e=document.cookie.split("; ").find(r=>r.startsWith("csrf_token="));if(e)return e.split("=")[1];const n=localStorage.getItem("csrf_token");return n||(window.csrf_token?window.csrf_token:"")}async refreshCSRFToken(){try{const t=await fetch(`${this.baseURL}/api/method/frappe.auth.get_logged_user`,{credentials:"include"});if(t.ok){const e=t.headers.get("X-Frappe-CSRF-Token");if(e)return localStorage.setItem("csrf_token",e),e;const n=this.getCSRFToken();if(n)return localStorage.setItem("csrf_token",n),n}}catch(t){console.error("Failed to refresh CSRF token:",t)}return""}async queueOfflineWrite(t,e,n,r="update"){const s=await this.queueStore.getItem("write_queue")||[],o={id:`${Date.now()}_${Math.random()}`,doctype:t,name:e,data:n,action:r,timestamp:Date.now()};return s.push(o),await this.queueStore.setItem("write_queue",s),{queued:!0,offline:!0,queueId:o.id,message:"Saved offline. Will sync when online."}}async syncOfflineData(){const t=await this.queueStore.getItem("write_queue")||[];if(t.length===0)return{synced:0,failed:[]};const e={synced:0,failed:[]};for(const n of t)try{n.action==="create"?await this.createDoc(n.doctype,n.data):n.action==="update"?await this.setDoc(n.doctype,n.name,n.data):n.action==="delete"&&await this.deleteDoc(n.doctype,n.name),e.synced++}catch(r){console.error("Sync failed for item:",n,r),e.failed.push({item:n,error:r.message})}return e.failed.length===0?await this.queueStore.setItem("write_queue",[]):await this.queueStore.setItem("write_queue",e.failed.map(n=>n.item)),e}async getPendingQueueCount(){return(await this.queueStore.getItem("write_queue")||[]).length}async handleOfflineRequest(t){const e=await this.offlineStore.getItem(t);return e?e.data:{offline:!0,error:"No cached data available",message:"You are offline and this data is not cached"}}async clearCache(){await this.offlineStore.clear(),await this.queueStore.clear()}delay(t){return new Promise(e=>setTimeout(e,t))}async isAuthenticated(){try{const t=await fetch(`${this.baseURL}/api/method/frappe.auth.get_logged_user`,{credentials:"include",headers:{"X-Frappe-CSRF-Token":this.getCSRFToken()}});if(!t.ok)return!1;const e=await t.json();return e.message&&e.message!=="Guest"}catch{return!1}}async getCurrentUser(){try{const t=await fetch(`${this.baseURL}/api/method/frappe.auth.get_logged_user`,{credentials:"include",headers:{"X-Frappe-CSRF-Token":this.getCSRFToken()}});if(!t.ok)return null;const e=await t.json();return e.message!=="Guest"?e.message:null}catch{return null}}}const k=new se,oe=b("auth",()=>{const u=v(null),t=v(null),e=v([]),n=v([]),r=v(!1),s=v(null),o=T(()=>!!u.value&&u.value.name!=="Guest"),a=T(()=>t.value?.employee_name||u.value?.full_name||"User"),l=T(()=>a.value.split(" ").map(w=>w[0]).slice(0,2).join("").toUpperCase());async function c(){r.value=!0,s.value=null;try{await k.refreshCSRFToken();const f=await k.getCurrentUser();if(!f||f==="Guest")throw new Error("Not authenticated");const w=await k.getDoc("User",f);if(u.value=w,n.value=w.roles?.map(m=>m.role)||[],w.name)try{const m=await k.getList("Employee",["name","employee_name","designation","image","department","cell_number"],[["user_id","=",w.name]],1);m&&m.length>0&&(t.value=m[0])}catch(m){console.warn("Employee not found for user:",m)}return w}catch(f){throw s.value=f.message,console.error("Failed to fetch user info:",f),f}finally{r.value=!1}}function i(f){return n.value.includes(f)}function h(f){return f.some(w=>n.value.includes(w))}function p(f,w="read"){return!0}async function d(f,w){r.value=!0,s.value=null;try{const m=await fetch(`${window.location.origin}/api/method/login`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({usr:f,pwd:w})});if(!m.ok){const P=await m.json().catch(()=>({}));throw new Error(P.message||"Login failed")}if((await m.json()).message==="Logged In")return await k.refreshCSRFToken(),await c(),!0;throw new Error("Invalid credentials")}catch(m){throw console.error("Login error:",m),s.value=m.message||"Login failed",m}finally{r.value=!1}}async function g(){try{await k.call("logout"),u.value=null,t.value=null,e.value=[],n.value=[],window.location.href="/login"}catch(f){console.error("Logout failed:",f),s.value=f.message}}function S(){u.value=null,t.value=null,e.value=[],n.value=[],s.value=null}return{user:u,employee:t,permissions:e,roles:n,loading:r,error:s,isAuthenticated:o,userName:a,userInitials:l,fetchUserInfo:c,login:d,hasRole:i,hasAnyRole:h,hasPermission:p,logout:g,clearAuth:S}}),ae=b("offline",()=>{const u=v(navigator.onLine),t=v(!1),e=v(null),n=v(0),r=v([]),s=T(()=>t.value),o=T(()=>n.value>0),a=T(()=>{if(!e.value)return"Never";const d=Date.now()-e.value,g=Math.floor(d/6e4);if(g<1)return"Just now";if(g===1)return"1 minute ago";if(g<60)return`${g} minutes ago`;const S=Math.floor(g/60);if(S===1)return"1 hour ago";if(S<24)return`${S} hours ago`;const f=Math.floor(S/24);return f===1?"1 day ago":`${f} days ago`});function l(){window.addEventListener("online",()=>{u.value=!0,i()}),window.addEventListener("offline",()=>{u.value=!1}),c(),setInterval(()=>{u.value&&!t.value&&i()},300*1e3)}async function c(){try{n.value=await k.getPendingQueueCount()}catch(d){console.error("Failed to update queue count:",d)}}async function i(){if(!(t.value||!u.value)){t.value=!0,r.value=[];try{const d=await k.syncOfflineData();return d.synced>0&&(console.log(`Synced ${d.synced} offline changes`),e.value=Date.now()),d.failed&&d.failed.length>0&&(r.value=d.failed,console.error("Some items failed to sync:",d.failed)),await c(),d}catch(d){console.error("Sync failed:",d),r.value.push({error:d.message})}finally{t.value=!1}}}async function h(){try{await k.clearCache(),n.value=0,r.value=[],e.value=null}catch(d){throw console.error("Failed to clear offline data:",d),d}}async function p(){return i()}return{isOnline:u,syncInProgress:t,lastSyncTime:e,queueCount:n,syncErrors:r,isSyncing:s,hasPendingChanges:o,lastSyncFormatted:a,init:l,updateQueueCount:c,syncOfflineData:i,clearOfflineData:h,retryFailed:p}});function ie(u={}){const{autoInit:t=!1}=u,e=ae(),{isOnline:n,syncInProgress:r,lastSyncTime:s,queueCount:o,syncErrors:a,isSyncing:l,hasPendingChanges:c,lastSyncFormatted:i}=A(e);return t&&D(()=>{e.init()}),{isOnline:n,syncInProgress:r,lastSyncTime:s,queueCount:o,syncErrors:a,isSyncing:l,hasPendingChanges:c,lastSyncFormatted:i,init:e.init,sync:e.syncOfflineData,updateQueueCount:e.updateQueueCount,clearCache:e.clearOfflineData,retryFailed:e.retryFailed}}const L=v([]);let ce=0;function le(){const u=T(()=>L.value);function t(i,h="info",p=3e3){const d=ce++,g={id:d,message:i,type:h,visible:!0,timestamp:Date.now()};return L.value.push(g),p>0&&setTimeout(()=>{e(d)},p),d}function e(i){const h=L.value.findIndex(p=>p.id===i);h>-1&&L.value.splice(h,1)}function n(){L.value=[]}function r(i,h=3e3){return t(i,"success",h)}function s(i,h=5e3){return t(i,"error",h)}function o(i,h=4e3){return t(i,"warning",h)}function a(i,h=3e3){return t(i,"info",h)}function l(i="Loading..."){return t(i,"info",0)}async function c(i,h={}){const{loading:p="Loading...",success:d="Success!",error:g="Error occurred"}=h,S=t(p,"info",0);try{const f=await i;return e(S),r(d),f}catch(f){throw e(S),s(g+(f.message?`: ${f.message}`:"")),f}}return{toasts:u,show:t,dismiss:e,dismissAll:n,success:r,error:s,warning:o,info:a,loading:l,promise:c}}const ue=(u,t)=>{const e=u.__vccOpts||u;for(const[n,r]of t)e[n]=r;return e},de=["onClick"],fe={class:"flex items-start space-x-3 p-4"},he={class:"flex-shrink-0"},pe={key:0,class:"w-6 h-6",fill:"currentColor",viewBox:"0 0 20 20"},me={key:1,class:"w-6 h-6",fill:"currentColor",viewBox:"0 0 20 20"},ge={key:2,class:"w-6 h-6",fill:"currentColor",viewBox:"0 0 20 20"},we={key:3,class:"w-6 h-6",fill:"currentColor",viewBox:"0 0 20 20"},ye={class:"flex-1 pt-0.5"},ve={class:"text-sm font-medium"},_e=["onClick"],Se={key:0,class:"h-1 bg-white bg-opacity-30 rounded-b"},Ce={__name:"Toast",setup(u){const{toasts:t,dismiss:e}=le();function n(o){const a=["rounded-lg shadow-lg max-w-sm w-full transform transition-all duration-300 cursor-pointer","hover:scale-105"],l={success:"bg-green-600 text-white",error:"bg-red-600 text-white",warning:"bg-yellow-500 text-gray-900",info:"bg-blue-600 text-white"};return[...a,l[o.type]||l.info].join(" ")}function r(o){e(o)}function s(o){const l=Date.now()-o.timestamp,c=o.duration||3e3;return Math.max(0,c-l)/c*100}return(o,a)=>(C(),x(M,{to:"body"},[F(j,{name:"toast",tag:"div",class:"fixed top-4 right-4 z-50 space-y-2 pointer-events-none"},{default:U(()=>[(C(!0),R(N,null,W(I(t),l=>(C(),R("div",{key:l.id,class:z([n(l),"pointer-events-auto"]),onClick:c=>r(l.id)},[y("div",fe,[y("div",he,[l.type==="success"?(C(),R("svg",pe,[...a[0]||(a[0]=[y("path",{"fill-rule":"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z","clip-rule":"evenodd"},null,-1)])])):l.type==="error"?(C(),R("svg",me,[...a[1]||(a[1]=[y("path",{"fill-rule":"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z","clip-rule":"evenodd"},null,-1)])])):l.type==="warning"?(C(),R("svg",ge,[...a[2]||(a[2]=[y("path",{"fill-rule":"evenodd",d:"M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z","clip-rule":"evenodd"},null,-1)])])):(C(),R("svg",we,[...a[3]||(a[3]=[y("path",{"fill-rule":"evenodd",d:"M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z","clip-rule":"evenodd"},null,-1)])]))]),y("div",ye,[y("p",ve,B(l.message),1)]),y("button",{type:"button",onClick:X(c=>r(l.id),["stop"]),class:"flex-shrink-0 text-current opacity-70 hover:opacity-100 transition-opacity"},[...a[4]||(a[4]=[y("svg",{class:"w-5 h-5",fill:"currentColor",viewBox:"0 0 20 20"},[y("path",{"fill-rule":"evenodd",d:"M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z","clip-rule":"evenodd"})],-1)])],8,_e)]),l.duration>0?(C(),R("div",Se,[y("div",{class:"h-full bg-white bg-opacity-50 rounded-b transition-all",style:H({width:s(l)+"%"})},null,4)])):V("",!0)],10,de))),128))]),_:1})]))}},ke=ue(Ce,[["__scopeId","data-v-e932529d"]]),Re=[{path:"/login",name:"Login",component:()=>_(()=>import("./Login-471oyKIN.js"),__vite__mapDeps([0,1,2,3])),meta:{requiresAuth:!1}},{path:"/",component:()=>_(()=>import("./Layout-B1PQsy11.js"),__vite__mapDeps([4,2,1,3])),meta:{requiresAuth:!0},children:[{path:"",name:"Dashboard",component:()=>_(()=>import("./Dashboard-BUjUSF5b.js"),__vite__mapDeps([5,1,3]))},{path:"incidents",name:"Incidents",component:()=>_(()=>import("./Incidents-BOsa0AFR.js"),__vite__mapDeps([6,1,3]))},{path:"incidents/:id",name:"IncidentDetails",component:()=>_(()=>import("./IncidentDetails-CnPGN6J6.js"),__vite__mapDeps([7,1,3]))},{path:"audits",name:"SafetyAudits",component:()=>_(()=>import("./SafetyAudits-CrOc7A8Y.js"),__vite__mapDeps([8,1,3]))},{path:"compliance",name:"Compliance",component:()=>_(()=>import("./Compliance-taaNpXp4.js"),__vite__mapDeps([9,1,3]))},{path:"risk-assessment",name:"RiskAssessment",component:()=>_(()=>import("./RiskAssessment-0iBqA98S.js"),__vite__mapDeps([10,1,3]))},{path:"reports",name:"Reports",component:()=>_(()=>import("./Reports-lEwIutd_.js"),__vite__mapDeps([11,1,3]))},{path:"settings",name:"Settings",component:()=>_(()=>import("./Settings-BVeyQxwk.js"),__vite__mapDeps([12,1,3]))}]}],q=J({history:G("/safety/"),routes:Re});q.beforeEach((u,t,e)=>{const n=oe();u.meta.requiresAuth&&!n.isAuthenticated?e({name:"Login",query:{redirect:u.fullPath}}):u.name==="Login"&&n.isAuthenticated?e({name:"Dashboard"}):e()});const Te={id:"app",class:"min-h-screen bg-gray-50"},Le={__name:"App",setup(u){const{init:t}=ie();return D(()=>{t()}),(e,n)=>{const r=Q("router-view");return C(),R("div",Te,[F(r),F(I(ke))])}}},E=K(Le),Fe=Y();E.use(Fe);E.use(q);E.mount("#app");export{ue as _,le as a,k as f,oe as u};
//# sourceMappingURL=index-CzaUriAi.js.map
