%% TEMS Entity Relationship Diagram (ERD)
%% Generated by AI Architect Agent - October 16, 2025
%% This diagram shows Vehicle as the central operational unit with Assets, Operations, and Finance integration
%% Render with: mmdc -i tems_erd.mmd -o tems_erd.png -t dark -b transparent

erDiagram
    %% Core ERPNext Extensions (read-only from TEMS perspective)
    VEHICLE ||--o{ ASSET : "has many"
    VEHICLE ||--o{ TYRE : "has many"
    VEHICLE ||--o{ JOURNEY_PLAN : "assigned to"
    VEHICLE ||--o{ OPERATION_PLAN : "executes"
    VEHICLE ||--o{ TRIP_ALLOCATION : "allocated in"
    VEHICLE ||--o{ MOVEMENT_LOG : "tracks"
    VEHICLE ||--o{ COST_REVENUE_LEDGER : "costs/revenues"
    VEHICLE ||--o{ FUEL_LOG : "consumes"
    VEHICLE ||--o{ MAINTENANCE_WORK_ORDER : "requires"
    VEHICLE ||--o{ EMISSIONS_LOG : "emits"
    VEHICLE ||--o{ BORDER_CROSSING : "crosses"
    VEHICLE ||--o{ CARGO_MANIFEST : "carries"
    VEHICLE ||--o{ PASSENGER_TRIP : "transports"
    
    EMPLOYEE ||--o{ DRIVER_QUALIFICATION : "qualified as"
    EMPLOYEE ||--o{ TRIP_ALLOCATION : "assigned as driver"
    EMPLOYEE ||--o{ DUTY_ASSIGNMENT : "assigned duty"
    EMPLOYEE ||--o{ TRAINING_RECORD : "receives"
    
    CUSTOMER ||--o{ OPERATION_PLAN : "requests"
    CUSTOMER ||--o{ FIELD_SERVICE_REQUEST : "raises"
    CUSTOMER ||--o{ CUSTOMER_FEEDBACK : "provides"
    
    SUPPLIER ||--o{ MAINTENANCE_WORK_ORDER : "services"
    SUPPLIER ||--o{ SPARE_PART : "supplies"
    
    %% TEMS Asset Management
    ASSET ||--o| TYRE : "can be"
    ASSET ||--o{ ASSET_UTILIZATION_LOG : "tracked by"
    ASSET ||--o{ COST_REVENUE_LEDGER : "contributes cost"
    
    TYRE ||--o{ TYRE_INSTALLATION_LOG : "installation history"
    TYRE ||--o{ TYRE_ROTATION_LOG : "rotation history"
    TYRE ||--o{ TYRE_INSPECTION_LOG : "inspections"
    TYRE ||--o{ TYRE_SENSOR_DATA : "sensor readings"
    TYRE ||--o{ TYRE_DISPOSAL_LOG : "disposal"
    
    %% TEMS Operations (Central Hub)
    OPERATION_PLAN ||--o{ MOVEMENT_LOG : "generates"
    OPERATION_PLAN ||--o{ OPERATIONS_EVENT : "logged events"
    OPERATION_PLAN ||--o{ CONTROL_EXCEPTION : "exceptions"
    OPERATION_PLAN ||--o{ SOS_EVENT : "emergencies"
    OPERATION_PLAN ||--o{ CARGO_MANIFEST : "cargo details"
    OPERATION_PLAN ||--o{ PASSENGER_TRIP : "passenger details"
    OPERATION_PLAN ||--o{ JOURNEY_COSTING : "costed by"
    
    JOURNEY_PLAN ||--o{ TRIP_ALLOCATION : "includes"
    JOURNEY_PLAN ||--o{ RISK_ASSESSMENT : "assessed by"
    JOURNEY_PLAN ||--o{ BORDER_CROSSING : "crosses borders"
    
    DISPATCH_SCHEDULE ||--o{ SHIFT_PLAN : "schedules"
    SHIFT_PLAN ||--o{ DUTY_ASSIGNMENT : "assigns"
    
    ROUTE_PLANNING ||--o{ JOURNEY_PLAN : "used by"
    ROUTE_PLANNING ||--o{ TRADE_LANE : "includes"
    
    %% TEMS Cargo & Passenger (Multimodal)
    CARGO_MANIFEST ||--o{ CARGO_CONSIGNMENT : "contains"
    CARGO_CONSIGNMENT ||--o{ WAYBILL : "documented by"
    CARGO_CONSIGNMENT ||--o{ DELIVERY_LOG : "delivered"
    
    PASSENGER_TRIP ||--o{ BOOKING : "bookings"
    PASSENGER_TRIP ||--o{ ROUTE_SCHEDULE : "follows"
    
    %% TEMS Safety
    JOURNEY_PLAN ||--o{ INCIDENT_REPORT : "incidents during"
    INCIDENT_REPORT ||--o{ INCIDENT_PARTICIPANT : "involves"
    INCIDENT_REPORT ||--o{ SPOT_CHECK : "may trigger"
    
    SPOT_CHECK ||--o{ SPOT_CHECK_PHOTO : "documented by"
    
    DRIVER_QUALIFICATION ||--o{ COMPETENCY_MATRIX : "competencies"
    DRIVER_QUALIFICATION ||--o{ TRAINING_RECORD : "training"
    
    %% TEMS Finance
    VEHICLE ||--o{ FLEET_COSTS : "accumulates"
    JOURNEY_PLAN ||--o{ JOURNEY_COSTING : "costed"
    JOURNEY_COSTING ||--o{ COST_REVENUE_LEDGER : "feeds"
    
    LEASE_LOAN ||--o{ LEASE_LOAN_SCHEDULE : "payment schedule"
    
    FX_RISK_LOG ||--|| BORDER_CROSSING : "forex for"
    
    %% TEMS Trade
    TRADE_LANE ||--o{ TRADE_LANE_BORDER_POST : "border posts"
    TRADE_LANE ||--o{ TRADE_LANE_DOCUMENT : "required docs"
    BORDER_CROSSING ||--o{ CUSTOMS_CLEARANCE : "clearance"
    
    %% TEMS Governance
    POLICY ||--o{ COMPLIANCE_OBLIGATION : "obligations"
    COMPLIANCE_OBLIGATION ||--o{ COMPLIANCE_AUDIT : "audited by"
    
    SPOT_CHECK ||--|| VEHICLE : "inspects"
    SPOT_CHECK ||--|| EMPLOYEE : "inspector"
    
    %% TEMS Documents
    DOCUMENT_CHECKLIST ||--o{ DOCUMENT_CHECKLIST_ITEM : "items"
    
    %% TEMS CRM
    FIELD_SERVICE_REQUEST ||--|| EMPLOYEE : "assigned to"
    CUSTOMER_FEEDBACK ||--|| JOURNEY_PLAN : "about"
    
    %% TEMS Supply Chain
    SPARE_PART ||--o{ SPARE_REQUEST_ITEM : "requested in"
    SPARE_REQUEST ||--o{ SPARE_REQUEST_ITEM : "contains"
    LOGISTICS_TASK ||--|| ASSET : "for asset"
    
    %% TEMS Climate
    EMISSIONS_LOG ||--|| JOURNEY_PLAN : "from journey"
    CLIMATE_ALERT ||--o{ JOURNEY_PLAN : "affects"
    
    %% TEMS Informal Economy
    INFORMAL_OPERATOR ||--o{ OPERATOR_ROUTE_ASSOCIATION : "operates"
    OPERATOR_ROUTE_ASSOCIATION ||--|| ROUTE_PLANNING : "on route"
    TRIP_MATCH ||--|| INFORMAL_OPERATOR : "matched to"
    SAVINGS_GROUP ||--o{ SAVINGS_MEMBER : "members"
    
    %% TEMS AI Integration
    AI_CONFIGURATION ||--|| AI_MODEL_REGISTRY : "uses model"
    AI_INSIGHT_LOG }o--|| VEHICLE : "insights for"
    AI_INSIGHT_LOG }o--|| OPERATION_PLAN : "insights for"
    AI_INSIGHT_LOG }o--|| EMPLOYEE : "insights for"
    
    %% Core ERPNext Entities (Extended)
    VEHICLE {
        string name PK
        string license_plate
        string vehicle_type "Cargo/Passenger"
        string status
        float odometer_reading
        date last_service_date
        float health_score "AI-generated"
        float profitability "Finance rollup"
    }
    
    ASSET {
        string name PK
        string asset_name
        string asset_category
        link vehicle FK "Manyâ†’One"
        date purchase_date
        float gross_purchase_amount
        string status
    }
    
    TYRE {
        string name PK
        string brand
        string model
        string size
        string tyre_type
        link vehicle FK
        link asset FK "optional"
        float cost
        string status
        float health_index "AI 0-100"
        float cost_per_km
    }
    
    EMPLOYEE {
        string name PK
        string employee_name
        string designation
        string department
        string status
    }
    
    CUSTOMER {
        string name PK
        string customer_name
        string customer_type
    }
    
    SUPPLIER {
        string name PK
        string supplier_name
        string supplier_group
    }
    
    %% TEMS Operations
    OPERATION_PLAN {
        string name PK
        string title
        link vehicle FK "REQUIRED"
        select operation_mode "Cargo/Passenger"
        link driver FK
        datetime start_time
        datetime end_time
        string status
    }
    
    JOURNEY_PLAN {
        string name PK
        link vehicle FK
        link driver FK
        string route
        datetime departure
        datetime arrival
        float risk_score
    }
    
    TRIP_ALLOCATION {
        string name PK
        link journey_plan FK
        link vehicle FK "REQUIRED"
        link driver FK "REQUIRED"
        datetime schedule_slot
        string status
    }
    
    MOVEMENT_LOG {
        string name PK
        link vehicle FK "REQUIRED"
        link operation_plan FK
        select state "Check-In/In Transit/Delivered"
        datetime event_time
        float location_lat
        float location_lng
    }
    
    DISPATCH_SCHEDULE {
        string name PK
        date schedule_date
        text notes
    }
    
    SHIFT_PLAN {
        string name PK
        link dispatch_schedule FK
        time shift_start
        time shift_end
    }
    
    DUTY_ASSIGNMENT {
        string name PK
        link shift_plan FK
        link employee FK
        link vehicle FK
        string duty_type
    }
    
    OPERATIONS_EVENT {
        string name PK
        string journey_reference
        datetime event_time
        link vehicle FK
        select event_type
    }
    
    CONTROL_EXCEPTION {
        string name PK
        select type "Delay/Breakdown"
        select severity
        datetime occurred_at
        link vehicle FK
    }
    
    SOS_EVENT {
        string name PK
        link vehicle FK
        link driver FK
        datetime event_time
        float lat
        float lng
        string status
    }
    
    %% TEMS Cargo & Passenger
    CARGO_MANIFEST {
        string name PK
        link operation_plan FK "REQUIRED"
        link vehicle FK "REQUIRED"
        float total_weight_kg
    }
    
    CARGO_CONSIGNMENT {
        string name PK
        link cargo_manifest FK
        link customer FK
        string consignment_no
    }
    
    WAYBILL {
        string name PK
        link cargo_consignment FK
        string waybill_no
    }
    
    DELIVERY_LOG {
        string name PK
        link cargo_consignment FK
        datetime delivered_at
    }
    
    PASSENGER_TRIP {
        string name PK
        link operation_plan FK
        link vehicle FK
        link route_schedule FK
        int passenger_count
    }
    
    BOOKING {
        string name PK
        link passenger_trip FK
        link customer FK
        int seat_number
    }
    
    ROUTE_SCHEDULE {
        string name PK
        link route_planning FK
        time departure_time
    }
    
    %% TEMS Fleet
    MAINTENANCE_WORK_ORDER {
        string name PK
        link vehicle FK
        link asset FK "optional"
        link supplier FK
        date scheduled_date
        string status
        float estimated_cost
    }
    
    FUEL_LOG {
        string name PK
        link vehicle FK
        date log_date
        float quantity_liters
        float cost
    }
    
    ASSET_UTILIZATION_LOG {
        string name PK
        link asset FK
        link vehicle FK
        float utilization_hours
        date log_date
    }
    
    ROUTE_PLANNING {
        string name PK
        string route_name
        string origin
        string destination
        float distance_km
    }
    
    %% TEMS Tyre (Detailed)
    TYRE_INSTALLATION_LOG {
        string name PK
        link tyre FK
        link vehicle FK
        string position
        date installation_date
        float odometer_reading
    }
    
    TYRE_ROTATION_LOG {
        string name PK
        link tyre FK
        string from_position
        string to_position
        date rotation_date
    }
    
    TYRE_INSPECTION_LOG {
        string name PK
        link tyre FK
        link inspector FK
        date inspection_date
        float pressure_psi
        float tread_depth_mm
        string condition "AI-classified"
    }
    
    TYRE_SENSOR_DATA {
        string name PK
        string sensor_id
        link tyre FK
        datetime timestamp
        float pressure_psi
        float temperature_c
        float speed_kmh
    }
    
    TYRE_DISPOSAL_LOG {
        string name PK
        link tyre FK
        date disposal_date
        string disposal_method
        float scrap_value
    }
    
    %% TEMS Safety
    INCIDENT_REPORT {
        string name PK
        link journey_plan FK
        datetime incident_time
        select severity
        text description
    }
    
    INCIDENT_PARTICIPANT {
        string name PK
        link incident_report FK
        link employee FK
        string role
    }
    
    SPOT_CHECK {
        string name PK
        link vehicle FK
        link inspector FK
        date check_date
        string findings
    }
    
    SPOT_CHECK_PHOTO {
        string name PK
        link spot_check FK
        attach photo
    }
    
    RISK_ASSESSMENT {
        string name PK
        link journey_plan FK
        float risk_score
        date assessment_date
    }
    
    DRIVER_QUALIFICATION {
        string name PK
        link employee FK
        string license_no
        date expiry_date
        date medical_clearance_date
    }
    
    COMPETENCY_MATRIX {
        string name PK
        link driver_qualification FK
        string competency
        int score
    }
    
    TRAINING_RECORD {
        string name PK
        link employee FK
        string training_type
        date completion_date
    }
    
    %% TEMS Finance
    COST_REVENUE_LEDGER {
        string name PK
        date date
        link vehicle FK "REQUIRED"
        select type "Cost/Revenue"
        currency amount
        link asset FK "optional breakdown"
        string reference_doctype
    }
    
    FLEET_COSTS {
        string name PK
        link vehicle FK
        select cost_type "Fuel/Maintenance/Toll"
        currency amount
        string reference_doctype
    }
    
    JOURNEY_COSTING {
        string name PK
        link journey_plan FK
        currency total_cost
        currency total_revenue
        currency profit
    }
    
    LEASE_LOAN {
        string name PK
        link asset FK
        currency loan_amount
        float interest_rate
        int tenure_months
    }
    
    LEASE_LOAN_SCHEDULE {
        string name PK
        link lease_loan FK
        date due_date
        currency amount
    }
    
    FX_RISK_LOG {
        string name PK
        link border_crossing FK
        currency amount_local
        currency amount_foreign
        float exchange_rate
    }
    
    %% TEMS Trade
    TRADE_LANE {
        string name PK
        string lane_name
        string origin_country
        string destination_country
    }
    
    TRADE_LANE_BORDER_POST {
        string name PK
        link trade_lane FK
        string border_post
        int sequence
    }
    
    TRADE_LANE_DOCUMENT {
        string name PK
        link trade_lane FK
        string document_type
    }
    
    BORDER_CROSSING {
        string name PK
        link journey_plan FK
        link vehicle FK
        string border_post
        datetime entry_time
        datetime exit_time
    }
    
    CUSTOMS_CLEARANCE {
        string name PK
        link border_crossing FK
        string declaration_no
        string status
    }
    
    %% TEMS Governance
    POLICY {
        string name PK
        string policy_name
        date effective_date
        string applies_to
    }
    
    COMPLIANCE_OBLIGATION {
        string name PK
        link policy FK
        string obligation
        date due_date
    }
    
    COMPLIANCE_AUDIT {
        string name PK
        link compliance_obligation FK
        date audit_date
        string result
    }
    
    %% TEMS Documents
    DOCUMENT_CHECKLIST {
        string name PK
        select context "Asset/Driver/Trip"
    }
    
    DOCUMENT_CHECKLIST_ITEM {
        string name PK
        link document_checklist FK
        string document_name
        check is_mandatory
    }
    
    %% TEMS CRM
    FIELD_SERVICE_REQUEST {
        string name PK
        link customer FK
        link employee FK "assigned"
        string request_type
        string status
    }
    
    CUSTOMER_FEEDBACK {
        string name PK
        link customer FK
        link journey_plan FK
        int rating
        text comments
    }
    
    %% TEMS Supply Chain
    SPARE_PART {
        string name PK
        string part_name
        link supplier FK
        currency unit_price
    }
    
    SPARE_REQUEST {
        string name PK
        date request_date
        string status
    }
    
    SPARE_REQUEST_ITEM {
        string name PK
        link spare_request FK
        link spare_part FK
        int quantity
    }
    
    LOGISTICS_TASK {
        string name PK
        string task_type
        link asset FK
        string status
    }
    
    SUPPLIER_RATING {
        string name PK
        link supplier FK
        int rating
        date rating_date
    }
    
    %% TEMS Climate
    EMISSIONS_LOG {
        string name PK
        link vehicle FK "REQUIRED"
        link journey_plan FK
        float fuel_liters
        float co2e_kg
    }
    
    CLIMATE_ALERT {
        string name PK
        string alert_type
        string severity
        text description
    }
    
    %% TEMS Informal Economy
    INFORMAL_OPERATOR {
        string name PK
        string operator_name
        string phone
        string ussd_id
    }
    
    OPERATOR_ROUTE_ASSOCIATION {
        string name PK
        link informal_operator FK
        link route_planning FK
    }
    
    TRIP_MATCH {
        string name PK
        link informal_operator FK
        datetime match_time
        string status
    }
    
    SAVINGS_GROUP {
        string name PK
        string group_name
        currency total_savings
    }
    
    SAVINGS_MEMBER {
        string name PK
        link savings_group FK
        link informal_operator FK
    }
    
    %% TEMS AI
    AI_CONFIGURATION {
        string name PK
        select domain "Fleet/Operations/Safety/Finance"
        select insight_mode
        link model FK
    }
    
    AI_MODEL_REGISTRY {
        string name PK
        string model_name
        select model_type
        select source "Local/API/External"
        string endpoint
    }
    
    AI_INSIGHT_LOG {
        string name PK
        select domain
        string insight_type
        json prediction_value
        float confidence_score
        datetime generated_at
    }
